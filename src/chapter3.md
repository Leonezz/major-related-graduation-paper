---
bibliography: [../ref.bib]
fignos-cleveref: True
fignos-caption-name: 图
tablenos-cleveref: True
tablenos-caption-name: 表
---

# 数据采集与控制终端设计与实现

## 终端系统主要硬件电路设计与实现

### 硬件电路总体设计

系统硬件系统主要包括电源电路部分、单片机最小系统部分、传感器外设部分、桶盖控制部分，扫码器部分和上位机接口部分。其中传感器外设部分又可以分为温湿度传感器部分、重量传感器部分、桶满传感器部分、用户接近传感器部分和可燃气体传感器部分。硬件系统将终端系统的电源电路、单片机控制核心、传感器外设接口等部分集中在一块电路板上，可以显著减小系统的体积，更具适应性。图{@fig:HardwareStructure}所示为系统硬件电路架构设计图。

![硬件电路结构设计图](imgs/HardwareStructure.png){#fig:HardwareStructure width=14cm}

该设计中，MCU（单片机）用于处理所有的传感器数据并与上位机通信；温湿度传感器、重量传感器、桶满状态传感器、可燃气体传感器用于监测垃圾桶内状态信息；用户接近模块和扫码器模块用于人机交互系统，提供更好的使用体验；上位机接口则用于与Android上位机通信。

### 单片机最小系统电路设计

出于成本和性能以及外设接口的丰富程度的综合考虑，本系统的单片机控制器选择意法半导体公司生产的STM32F103系列型微控制器。STM32F103系列微控制器基于Arm-Cortex-M3内核，主频最高为72MHz，内置Flash空间大小覆盖了从16KBytes到1MBytes的范围。根据内置Flash大小和RAM大小以及单片机针脚数量，STM32F103系列单片机可以分为如图{@fig:STM32F103Series}所示的29个型号。

![STM32F103系列单片机分类](imgs/STM32F103Series.png){#fig:STM32F103Series width=16cm}

结合系统所需的外设种类和数量以及程序库编译后的二进制体积考虑，本设计选择了STM32F103RE系列单片机，它有64个引脚（其中51个是GPIO引脚，其余13个是电源，晶振等引脚），可以满足系统外设的连接控制需求；同时它内置了512KBytes大小的Flash和64KBytes大小的RAM，可以满足外设驱动和通信协议栈的程序运行。

由于本系统不需要再零下40摄氏度以下或85摄氏度以上的极端环境下工作，因此选定微控制器的型号为可在-40℃~85℃下工作的STM32F103RET6。

该型微控制器基础参数（局部）如表{@tbl:STM32F103RET6}所示[@Chong2020]：

| Flash大小 | SRAM大小 | Timer | SPI | I2C | U(S)ART | GPIO | 12位ADC |
| --------- | -------- | ----- | --- | --- | ------- | ---- | ------- |
| 512KB     | 64KB     | 8个   | 3个 | 2个 | 5个     | 51个 | 3个     |
Table:STM32F103RET6型微控制器基础参数表 {#tbl:STM32F103RET6}

可以看出该型微控制器的U(S)ART接口资源较为丰度，可以连接控制多个独立的串口设备。本系统所需的单片机最小系统电路与一般的STM32F103RET6系统别无二致，图{@fig:MCUCircute}所示是最小系统电路原理图。

![控制系统核心电路原理图](imgs/MCUCircute.png){#fig:MCUCircute width=14cm}

该电路设计图中包含SWD调试接口、系统指示灯、复位电路、晶振电路、电源电路和MCU引脚等几个部分。

SWD调试即串行调试（Serial Wire Debug），是一种最少只需要占用单片机的2个引脚就可以实现内核访问调试的调试协议[@HuangYaPing2012, @HuangGuoWei2019, @Shi2020, @Shi2019]。使用SWD调试接口进行Arm-Cortex内核单片机的调试和程序下载，可以节约外设资源和减小电路板体积。

系统指示灯作为系统运行的指示，向系统维护人员传递系统仍在运行的信息。

复位电路由复位按键和上电复位电路[@Song2021]组成。STM32的单片机是低电平复位的，当上电时，STM32单片机的NSRT引脚电平为低时，单片机会将内部各寄存器的值重设为初始状态，随后NSRT引脚电平为高时，单片机正常工作，由此完成复位过程。复位电路上有电阻和电容构成的RC电路，这种RC电路可以时NRST引脚上的电压缓慢变化，防止电压突变造成故障。当单片机内部出现故障时，有时也需要对单片机进行复位，这时可以按下复位按键使NSRT引脚接地，完成复位[@Lu2014]。

晶振电路是控制器核心电路的核心[@Zhao2016, @Wang2012]，它本身是一种能够把电能和机械能相互转化的晶体，当它在共振条件下工作时，就可以提供稳定，精确的单频信号。通常情况下，普通晶振的频率可以达到百万分之五[@Wang2020]，精度极高。利用它所产生的时钟信号，可以为单片机提供时钟频率，从而驱动单片机的指令执行。

STM32F103RET6的电源分为芯片工作电压、ADC参考电压、模拟电压和电池备用电源等，分别对应单片机的11个（5种）引脚。其对应关系如表{@tbl:MCUPower}所示。

| VDD        | VSS        | VDDA       | VSSA       | V_BAT    |
| ---------- | ---------- | ---------- | ---------- | -------- |
| 工作正电压 | 工作负电压 | 模拟正电压 | 模拟负电压 | 电池供电 |
Table:STM32F103RET6单片机电源引脚种类 {#tbl:MCUPower}

### 温湿度监测模块电路设计

温湿度监测模块的一般设计思路是通过温度和湿度的传感器安装在垃圾桶内部传感温湿度，本设计种为了结构的简约以及对节约单片机外设接口资源的考虑，使用温湿度一体传感器[@Lu2008]。现代的温湿度传感器根据原理的不同在结构上千差万别，根据测量对象、测量环境以及稳定性的考虑，本设计选用了YSAT01B型温湿度变送器作为温湿度监测模块的传感器。

该型温湿度传感器采用工业通用的RS485[@Xu2009, @FengZiLing2012, @Jia2010]总线MODBUS-RTU协议[@MODBUSStandard, @Fovino2009]接口，可以方便地通过串口进行通信。该型传感器可适配金属保护外壳，在垃圾桶场景下不易损坏。该型传感器技术参数如表{@tbl:TempSensorTable}所示。

| 温度测量范围 | $-30^oC~80^oC$                |
| ------------ | ----------------------------- |
| 温度测量精度 | $\pm0.3^oC(at 25^oC)$         |
| 湿度测量范围 | $0~100RH\%$                   |
| 湿度测量精度 | $\pm 3RH\%$                   |
| 通讯接口     | $RS485(MODBUS-RTU)$           |
| 供电电源     | $DC5~24V$                     |
| 分辨率       | 温度$0.01^oC$，湿度$0.01RH\%$ |
| 功耗         | $\leqslant 0.1W$              |
| 运行环境     | $-40^oC~120^oC,0~100RH\%$     |
Table:YSAT01B型温湿度变送器技术参数 {#tbl:TempSensorTable}

容易看出，该型传感器适用于本系统所工作的场景，且精度较高。图{@fig:TempSensorImage}所示是该型传感器的外形示意图。

![YSAT01B型温湿度变送器外形示意图](imgs/TempSensorImage.png){#fig:TempSensorImage width=11.35cm}

传感器有四条引脚接线，分别是电源正负极和RS485总线的AB差分线。根据此接口，设计传感器与单片机控制器之间的接口电路原理如图{@fig:TempSensorCircute}所示。

![温湿度传感器模块电路原理图](imgs/TempSensorCircute.png){#fig:TempSensorCircute width=16cm}

由于单片机的外设接口只有U(S)ART串口，不具有直接输出485差分信号的能力。本模块采用MAX3485ESA（图{@fig:TempSensorCircute}中的U9）实现了一个485与UART电平互转的电路[@Lei2014]，实现了单片机与传感器之间的通信。同时该部分电路设计有串口收发指示灯，用以提示维护人员该传感器与单片机之间的通信情况。

### 重量监测模块电路设计

在垃圾桶使用场景中，如果只依靠桶满传感器监测桶内垃圾容量，有时会出现“虚满”的现象。这是因为垃圾桶内部的垃圾可能存在许多蓬松的体积大（且可折叠压下）的垃圾。为了避免虚满对垃圾回收清理效率的影响，本设计采取桶满传感器与重量传感器结合的方式判断垃圾桶内剩余容量。当桶满传感器报告垃圾桶已满时，系统还要结合重量信息判断桶内是否出现了虚满现象。这样就可以避免系统出现误判。

考虑到使用场景中环境可能较为潮湿且重量较大，本设计选用常用于工业场景的悬臂梁式称重传感器[@Bi2020, @Gong2019, @Jin2014]实现对垃圾桶重量的监测。这种传感器的工作原理是惠斯通电桥[@Jin2020]，悬臂的应变区贴有应变片，可以感应到微小应变，并以电阻变化的形式表现，惠斯通电桥的四个桥即应变片。

该型传感器的技术参数和安装示意分别如表{@tbl:WeightATbl}和图{@fig:WeightAFig}所示。

| 量程           | $0~500kg$          | 零点温度漂移 | $0.03\%F.S./10^oC$          |
| -------------- | ------------------ | ------------ | --------------------------- |
| 输出灵敏度     | $2.0\pm0.05V/mV$   | 材质         | 铝合金                      |
| 零点输出       | $\pm1\%F.S.$       | 阻抗         | $350\Omega$                 |
| 非线性         | $0.02\%F.S.$       | 绝缘电阻     | $\geqslant5000M\Omega/100V$ |
| 滞后           | $0.03\%F.S.$       | 电压         | $5~15V$                     |
| 重复性         | $0.02\%F.S.$       | 工作温度     | $-20^oC~80^oC$              |
| 蠕变（30分钟） | $0.03\%F.S.$       | 安全超载     | $150\%$                     |
| 温度灵敏度漂移 | $0.03\%F.S./10^oC$ | 极限超载     | $200\%$                     |
Table:悬臂梁式称重传感器的典型技术参数和电气特性 {#tbl:WeightATbl}

![悬臂梁式称重传感器的一种安装方式示意图](imgs/WeightAFig.jpg){#fig:WeightAFig width=11.35cm}

由于单片机内部只有12位的ADC，其模拟信号测量精度最高只有$1/2^{12}V$，不足以满足设计需要。因此，本设计使用KYD-310式数字变送器采集称重传感器的模拟信号转化为数字量供单片机查询。这样控制系统的电路设计和软件设计不许考虑传感器细节，可以直接通过接口查询结果，简化了系统设计，实现了控制系统和外设传感器的解耦分离。表{@tbl:WeightDTbl}所示是KYD-310式数字变送器的技术规格。

| 供电电压       | $10V~30V$             |
| -------------- | --------------------- |
| 输入灵敏度     | $0.4mV/V~6mV/V$       |
| 传感器激励电压 | $5V\pm2\%$            |
| A/D参数        | 24位，Delta-Sigma方法 |
| 通信接口       | RS485(MODBUS-RTU)     |
| 精度           | 1/10000               |
| 工作温度       | $-30^oC~60^oC$        |
| 防护等级       | IP64                  |
Table:KYD-310型数字变送器技术规格 {#tbl:WeightDTbl}

由于与单片机直接通信的数字变送器采用RS485接口收发数据，所以单片机核心控制板上只需留有485和U(S)ART电平互转电路和接口即可，此模块电路原理图与图{@fig:TempSensorCircute}极为相似，此处不赘附。

### 桶满状态监测模块电路设计

对于垃圾高度信息，系统只需关心桶内垃圾是否已满，对于具体的高度数值无需详细采集。因此桶内垃圾高度采用E3F-DS30C4型红外接近开关采集，该型传感器可视为一种开关，其在被测表面距离较远时处于常开状态，此时公共端与常开端短路，在被测表面对传感器造成遮挡时处于常闭状态，此时公共端与常闭端短路。电路原理图如图{@fig:FullCircute}所示。

![桶满状态监测模块电路原理图](imgs/FullCircute.png){#fig:FullCircute width=11.35cm}

该电路原理图设计中，红外接近开关的输出信号首先经过电阻分压后才接入单片机，分压比例为$V_{out} = V_{in}\times \frac{3.3}{5.3}$，可以保护单片机免遭过高电压的冲击而损坏。

### 用户接近监测模块电路设计

用户接近监测实际是在监测桶前方用户相距垃圾桶的距离，常用的距离检测方案式采用超声波测距传感器。考虑到超声波传感器的测距角度广、分辨率高以及结构简单可靠的特点[@Chen2021, @Wang2021]，本设计也选用超声波测距传感器进行用户接近的监测。所选用的超声传感器探头与常见的倒车雷达所使用的超声波传感器别无二致，其外观示意图如图{@fig:UltrasoundFig}所示。

![超声波传感器探头外观示意图](imgs/UltrasoundFig.jpg){#fig:UltrasoundFig width=10cm}

该传感器探头需要一定频率的信号才可以驱动，其反馈回的信号也是模拟信号，需要进一步标定才能转换为距离数值，较为复杂，因此，本设计使用了一个AJ-SRO4M-TX驱动模块来辅助完成超声波测距的任务，该模块的外观如图{@fig:AJ-SRO4M-TX}所示。

![AJ-SRO4M-TX模块外观示意图](imgs/AJ-SRO4M-TX.png){#fig:AJ-SRO4M-TX width=10cm}

该模块的数据通过标准的UART串口进行输出，因此此模块的接口电路不需要其他电平转换电路来适配，可以直接与单片机的UART外设接口连接。用户接近监测模块电路原理图如图{@fig:AJ-SRO4M-TXCircute}所示。

![用户接近监测模块电路设计图](imgs/AJ-SRO4M-TXCircute.png){#fig:AJ-SRO4M-TXCircute width=10cm}

### 可燃气体浓度监测模块电路设计

### 桶盖控制模块电路设计

### 扫码器模块电路设计

### 上位机接口部分电路设计

### 电源电路设计

### 终端系统硬件电路实现

## 终端系统软件设计与实现

### 系统软件整体架构

### 单片机核心系统固件设计

### 温湿度检测模块程序设计

### 重量检测模块程序设计

### 桶满状态检测模块程序设计

### 用户接近检测模块程序设计

### 可燃气体浓度检测模块程序设计

### 桶盖控制模块程序设计

### Modbus协议栈设计

### 终端系统软件实现

## 小结